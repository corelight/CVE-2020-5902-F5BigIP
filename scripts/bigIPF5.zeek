module CVE_2020_5902;
# A network detection package for CVE-2020-5902, a CVE10.0 vulnerability affecting F5 Networks, Inc BIG-IP devices.
# Tested on Zeek version 3.2.0-dev.459
# Author: Ben Reardon, Research Team @Corelight. ben.reardon@corelight.com, @benreardon
# Version: 0.1

export {
	redef enum Notice::Type += {
		BIGIP_exploit_attempt,
		BIGIP_exploit_success
	};
	redef record HTTP::Info += {
		cve20205902_have_seen_request: bool &optional &default = F;
		cve20205902_request_headers: string &optional;
	};
	option uri_patterns: pattern =
		/\/hsqldb\%0a/
	  | /\/hsqldb\x0a/
	  | /\/hsqldb\;/
	  | /\/tmui\/login\.jsp\/\.\.\;/
	  | /\.\.\;\/tmui\/locallb\//
	  # | /\/tmui\/login\.jsp\/\.\.\;\/tmui\/locallb\// # For ref, the combination of the previous 2 patterns
	  | /\/tmui\/login\.jsp\/\.\.\;\/login\.jsp/  # referenced in https://support.f5.com/csp/article/K52145254
	  ;
	# Change to T to only monitor for successful exploits.
	option only_monitor_for_successful_exploit: bool = F;
	# Set the snap length to limit the size of unbounded HTTP headers, to insert into notice.
	const max_header_length: int = 1500;
}

event http_all_headers(c: connection, is_orig: bool, hlist: mime_header_list)
	{
	if (!is_orig)
		return;
	if (!c$http?$uri)
		return;
	if (uri_patterns in to_lower(c$http$uri))
		{
		c$http$cve20205902_have_seen_request = T;
		c$http$cve20205902_request_headers = sub_bytes(cat(hlist),0,max_header_length);
		return;
		}
	}

event http_reply(c: connection, version: string, code: count, reason: string)
	{
	if (!c$http$cve20205902_have_seen_request)
		return;
	local notice_type = BIGIP_exploit_attempt;
	local msg_type: string = fmt("An attempt to exploit an F5 BIG-IP device via CVE-2020-5902 was detected using uri '%s' , however the server responded with a code='%s' reason='%s', indicating the exploit attempt failed. The HTTP request headers (up to %s bytes) are '%s'. Refer to https://support.f5.com/csp/article/K52145254"
								  ,c$http$uri, code, reason, max_header_length, c$http$cve20205902_request_headers);
	if (code == 200)
		{
		notice_type = BIGIP_exploit_success;	
		msg_type = fmt("A successful exploitation of an F5 BIG-IP device via CVE-2020-5902 was detected using uri '%s' , the server responded with a code='%s' reason='%s', indicating the exploit was successful. The HTTP request headers (up to %s bytes) are '%s'. Refer to https://support.f5.com/csp/article/K52145254"
						,c$http$uri, code, reason, max_header_length, c$http$cve20205902_request_headers);
		}
	else
		{
		if (only_monitor_for_successful_exploit)
			return;
		}
	NOTICE([$note=notice_type,
			$conn=c,
			$identifier=cat(c$id$orig_h,c$id$resp_h,c$http$uri,notice_type),
			$msg=msg_type]);
	}
